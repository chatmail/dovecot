From 62dcd47377f6a79785ba5df6b4a0a47a14adbe54 Mon Sep 17 00:00:00 2001
From: Stephan Bosch <stephan.bosch@dovecot.fi>
Date: Thu, 1 Nov 2018 00:44:10 +0100
Subject: [PATCH 09/17] lib-smtp: server: command: Move core of
 smtp_server_command_submit_reply() into a separate function.

Makes the next changes easier.
---
 src/lib-smtp/smtp-server-command.c | 53 ++++++++++++++++++++++----------------
 1 file changed, 31 insertions(+), 22 deletions(-)

diff --git a/src/lib-smtp/smtp-server-command.c b/src/lib-smtp/smtp-server-command.c
index cdc7b1b5b3..5cfa5786b7 100644
--- a/src/lib-smtp/smtp-server-command.c
+++ b/src/lib-smtp/smtp-server-command.c
@@ -391,6 +391,36 @@ void smtp_server_command_completed(struct smtp_server_command *cmd)
 	}
 }
 
+static bool
+smtp_server_command_handle_reply(struct smtp_server_command *cmd)
+{
+	struct smtp_server_connection *conn = cmd->context.conn;
+
+	smtp_server_command_replied(cmd);
+
+	/* submit reply */
+	smtp_server_connection_ref(conn);
+	switch (cmd->state) {
+	case SMTP_SERVER_COMMAND_STATE_NEW:
+	case SMTP_SERVER_COMMAND_STATE_PROCESSING:
+		if (!smtp_server_command_is_complete(cmd)) {
+			smtp_server_command_debug(&cmd->context,
+				"Not ready to reply");
+			cmd->state = SMTP_SERVER_COMMAND_STATE_SUBMITTED_REPLY;
+			break;
+		}
+		smtp_server_command_ready_to_reply(cmd);
+		break;
+	case SMTP_SERVER_COMMAND_STATE_READY_TO_REPLY:
+	case SMTP_SERVER_COMMAND_STATE_ABORTED:
+		break;
+	default:
+		i_unreached();
+	}
+
+	return smtp_server_connection_unref(&conn);
+}
+
 void smtp_server_command_submit_reply(struct smtp_server_command *cmd)
 {
 	struct smtp_server_connection *conn = cmd->context.conn;
@@ -422,34 +452,13 @@ void smtp_server_command_submit_reply(struct smtp_server_command *cmd)
 	cmd->hook_next = NULL;
 	cmd->context.hook_next = NULL;
 
-	smtp_server_command_replied(cmd);
-
 	/* limit number of consecutive bad commands */
 	if (is_bad)
 		conn->bad_counter++;
 	else if (cmd->replies_submitted == cmd->replies_expected)
 		conn->bad_counter = 0;
 
-	/* submit reply */
-	smtp_server_connection_ref(conn);
-	switch (cmd->state) {
-	case SMTP_SERVER_COMMAND_STATE_NEW:
-	case SMTP_SERVER_COMMAND_STATE_PROCESSING:
-		if (!smtp_server_command_is_complete(cmd)) {
-			smtp_server_command_debug(&cmd->context,
-				"Not ready to reply");
-			cmd->state = SMTP_SERVER_COMMAND_STATE_SUBMITTED_REPLY;
-			break;
-		}
-		smtp_server_command_ready_to_reply(cmd);
-		break;
-	case SMTP_SERVER_COMMAND_STATE_READY_TO_REPLY:
-	case SMTP_SERVER_COMMAND_STATE_ABORTED:
-		break;
-	default:
-		i_unreached();
-	}
-	if (!smtp_server_connection_unref(&conn))
+	if (!smtp_server_command_handle_reply(cmd))
 		return;
 
 	if (conn != NULL && conn->bad_counter > conn->set.max_bad_commands) {
-- 
2.11.0

