From c4ca98650cc71e0aa51de78de93ee9245717f704 Mon Sep 17 00:00:00 2001
From: Stephan Bosch <stephan.bosch@open-xchange.com>
Date: Tue, 24 Mar 2020 12:13:43 +0100
Subject: [PATCH 11/17] lib-smtp: smtp-server-command - Guarantee that
 non-destroy hooks aren't called for an ended command.

---
 src/lib-smtp/smtp-server-command.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/src/lib-smtp/smtp-server-command.c b/src/lib-smtp/smtp-server-command.c
index b63fbb1b00..0ee9986aae 100644
--- a/src/lib-smtp/smtp-server-command.c
+++ b/src/lib-smtp/smtp-server-command.c
@@ -316,6 +316,9 @@ void smtp_server_command_next_to_reply(struct smtp_server_command *cmd)
 
 	smtp_server_command_debug(&cmd->context, "Next to reply");
 
+	if (cmd->state >= SMTP_SERVER_COMMAND_STATE_FINISHED)
+		return;
+
 	/* execute private hook_next */
 	if (cmd->hook_next != NULL) {
 		smtp_server_cmd_func_t *hook_next = cmd->hook_next;
-- 
2.11.0

