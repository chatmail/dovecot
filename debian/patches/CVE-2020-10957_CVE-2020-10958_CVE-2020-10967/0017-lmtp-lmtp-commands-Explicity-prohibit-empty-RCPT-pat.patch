From 5f0bfc627883695eff48f92e8b57cc220f1ae596 Mon Sep 17 00:00:00 2001
From: Stephan Bosch <stephan.bosch@open-xchange.com>
Date: Fri, 20 Mar 2020 13:38:41 +0100
Subject: [PATCH 17/17] lmtp: lmtp-commands - Explicity prohibit empty RCPT
 path.

The empty path <""> will yield an empty username.
---
 src/lmtp/commands.c | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/src/lmtp/commands.c b/src/lmtp/commands.c
index 76d367e14e..17e8ee470a 100644
--- a/src/lmtp/commands.c
+++ b/src/lmtp/commands.c
@@ -51,9 +51,19 @@ int cmd_rcpt(void *conn_ctx, struct smtp_server_cmd_ctx *cmd,
 	char delim = '\0';
 	int ret;
 
+	i_assert(!smtp_address_isnull(data->path));
+	if (*data->path->localpart == '\0' && data->path->domain == NULL) {
+		smtp_server_reply(cmd, 550, "5.1.1", "<%s> "
+				 "Unacceptable TO: Empty path not allowed",
+				  smtp_address_encode(data->path));
+		return -1;
+	}
+
 	smtp_address_detail_parse_temp(
 		client->unexpanded_lda_set->recipient_delimiter,
 		data->path, &username, &delim, &detail);
+	i_assert(*username != '\0');
+
 	if (client->lmtp_set->lmtp_proxy) {
 		/* proxied? */
 		if ((ret=lmtp_proxy_rcpt(client, cmd, data,
-- 
2.11.0

