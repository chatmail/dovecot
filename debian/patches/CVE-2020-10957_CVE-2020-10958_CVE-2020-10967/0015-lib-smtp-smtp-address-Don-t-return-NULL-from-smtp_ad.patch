From d4d48764ca9e77e5e7a2eaeae526b4120807737b Mon Sep 17 00:00:00 2001
From: Stephan Bosch <stephan.bosch@open-xchange.com>
Date: Sun, 22 Mar 2020 18:14:44 +0100
Subject: [PATCH 15/17] lib-smtp: smtp-address - Don't return NULL from
 smtp_address_clone*() unless the input is NULL.

---
 src/lib-smtp/smtp-address.c | 20 ++++++++++++--------
 1 file changed, 12 insertions(+), 8 deletions(-)

diff --git a/src/lib-smtp/smtp-address.c b/src/lib-smtp/smtp-address.c
index bb31d34a67..c55e1a432b 100644
--- a/src/lib-smtp/smtp-address.c
+++ b/src/lib-smtp/smtp-address.c
@@ -617,17 +617,19 @@ struct smtp_address *
 smtp_address_clone(pool_t pool, const struct smtp_address *src)
 {
 	struct smtp_address *new;
-	size_t size, lpsize, dsize = 0;
-	char *data, *localpart, *domain = NULL;
+	size_t size, lpsize = 0, dsize = 0;
+	char *data, *localpart = NULL, *domain = NULL;
 
-	if (smtp_address_isnull(src))
+	if (src == NULL)
 		return NULL;
 
 	/* @UNSAFE */
 
 	size = sizeof(struct smtp_address);
-	lpsize = strlen(src->localpart) + 1;
-	size = MALLOC_ADD(size, lpsize);
+	if (!smtp_address_isnull(src)) {
+		lpsize = strlen(src->localpart) + 1;
+		size = MALLOC_ADD(size, lpsize);
+	}
 	if (src->domain != NULL) {
 		dsize = strlen(src->domain) + 1;
 		size = MALLOC_ADD(size, dsize);
@@ -635,8 +637,10 @@ smtp_address_clone(pool_t pool, const struct smtp_address *src)
 
 	data = p_malloc(pool, size);
 	new = (struct smtp_address *)data;
-	localpart = PTR_OFFSET(data, sizeof(*new));
-	memcpy(localpart, src->localpart, lpsize);
+	if (lpsize > 0) {
+		localpart = PTR_OFFSET(data, sizeof(*new));
+		memcpy(localpart, src->localpart, lpsize);
+	}
 	if (dsize > 0) {
 		domain = PTR_OFFSET(data, sizeof(*new) + lpsize);
 		memcpy(domain, src->domain, dsize);
@@ -677,7 +681,7 @@ smtp_address_clone_temp(const struct smtp_address *src)
 {
 	struct smtp_address *new;
 
-	if (smtp_address_isnull(src))
+	if (src == NULL)
 		return NULL;
 
 	new = t_new(struct smtp_address, 1);
-- 
2.11.0

