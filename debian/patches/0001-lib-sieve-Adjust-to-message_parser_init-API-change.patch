From cb631066bd58ad3b495b3938f5c0e0f9d68308df Mon Sep 17 00:00:00 2001
From: Timo Sirainen <timo.sirainen@open-xchange.com>
Date: Tue, 19 May 2020 15:40:04 +0300
Subject: [PATCH] lib-sieve: Adjust to message_parser_init() API change

---
 src/lib-sieve/plugins/notify/ext-notify-common.c |  6 +++++-
 src/lib-sieve/sieve-message.c                    | 12 ++++++------
 2 files changed, 11 insertions(+), 7 deletions(-)

Index: dovecot/pigeonhole/src/lib-sieve/plugins/notify/ext-notify-common.c
===================================================================
--- dovecot.orig/pigeonhole/src/lib-sieve/plugins/notify/ext-notify-common.c
+++ dovecot/pigeonhole/src/lib-sieve/plugins/notify/ext-notify-common.c
@@ -181,7 +181,11 @@ static int cmd_notify_extract_body_text
 	/* Initialize body decoder */
 	decoder = message_decoder_init(NULL, 0);
 
-	parser = message_parser_init(mctx->pool, input, 0, 0);
+	struct message_parser_settings mparser_set = {
+		.hdr_flags = 0,
+		.flags = 0,
+	};
+	parser = message_parser_init(mctx->pool, input, &mparser_set);
 	is_text = TRUE;
 	save_body = FALSE;
 	while ( (ret=message_parser_parse_next_block(parser, &block)) > 0 ) {
Index: dovecot/pigeonhole/src/lib-sieve/sieve-message.c
===================================================================
--- dovecot.orig/pigeonhole/src/lib-sieve/sieve-message.c
+++ dovecot/pigeonhole/src/lib-sieve/sieve-message.c
@@ -1076,10 +1076,10 @@ static int sieve_message_parts_add_missi
 	struct sieve_message_context *msgctx = renv->msgctx;
 	pool_t pool = msgctx->context_pool;
 	struct mail *mail = sieve_message_get_mail(renv->msgctx);
-	enum message_parser_flags mparser_flags =
-		MESSAGE_PARSER_FLAG_INCLUDE_MULTIPART_BLOCKS;
-	enum message_header_parser_flags hparser_flags =
-		MESSAGE_HEADER_PARSER_FLAG_SKIP_INITIAL_LWSP;
+	struct message_parser_settings mparser_set = {
+		.hdr_flags = MESSAGE_HEADER_PARSER_FLAG_SKIP_INITIAL_LWSP,
+		.flags = MESSAGE_PARSER_FLAG_INCLUDE_MULTIPART_BLOCKS,
+	};
 	ARRAY(struct sieve_message_header) headers;
 	struct sieve_message_part *body_part, *header_part, *last_part;
 	struct message_parser_ctx *parser;
@@ -1116,7 +1116,7 @@ static int sieve_message_parts_add_missi
 	if (iter_all) {
 		t_array_init(&headers, 64);
 		hdr_content = t_str_new(512);
-		hparser_flags |= MESSAGE_HEADER_PARSER_FLAG_CLEAN_ONELINE;
+		mparser_set.hdr_flags |= MESSAGE_HEADER_PARSER_FLAG_CLEAN_ONELINE;
 	} else {
 		i_zero(&headers);
 	}
@@ -1128,7 +1128,7 @@ static int sieve_message_parts_add_missi
 		//parser = message_parser_init_from_parts(parts, input,
 		// hparser_flags, mparser_flags);
 	parser = message_parser_init(pool_datastack_create(),
-		input, hparser_flags, mparser_flags);
+		input, &mparser_set);
 	while ( (ret=message_parser_parse_next_block
 		(parser, &block)) > 0 ) {
 		struct sieve_message_part **body_part_idx;
